{% extends "base.html" %} {% block title %}Gestion de la Hiérarchie{% endblock
%} {% block content %}
<div class="container-fluid">
    <!-- En-tête -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-diagram-3 text-info"></i>
                        Gestion de la Hiérarchie
                    </h1>
                    <p class="text-muted mb-0">
                        Gérer la hiérarchie Site > Lieu > Emplacement
                    </p>
                </div>
                <div class="btn-group">
                    <button
                        class="btn btn-info"
                        data-bs-toggle="modal"
                        data-bs-target="#nouveauSiteModal"
                    >
                        <i class="bi bi-plus-circle"></i> Nouveau Site
                    </button>
                    <button
                        class="btn btn-success"
                        data-bs-toggle="modal"
                        data-bs-target="#nouveauLieuModal"
                    >
                        <i class="bi bi-plus-circle"></i> Nouveau Lieu
                    </button>
                    <button
                        class="btn btn-warning"
                        data-bs-toggle="modal"
                        data-bs-target="#nouvelEmplacementModal"
                    >
                        <i class="bi bi-plus-circle"></i> Nouvel Emplacement
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center border-info">
                <div class="card-body">
                    <h5 class="card-title text-info">{{ sites|length }}</h5>
                    <p class="card-text">Sites</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-success">
                <div class="card-body">
                    <h5 class="card-title text-success">{{ lieux|length }}</h5>
                    <p class="card-text">Lieux</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-warning">
                <div class="card-body">
                    <h5 class="card-title text-warning">
                        {{ emplacements|length }}
                    </h5>
                    <p class="card-text">Emplacements</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-primary">
                <div class="card-body">
                    <h5 class="card-title text-primary">
                        {{ emplacements|selectattr('statut', 'equalto',
                        'Actif')|list|length }}
                    </h5>
                    <p class="card-text">Actifs</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Onglets -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <ul
                        class="nav nav-tabs card-header-tabs"
                        id="hierarchyTabs"
                        role="tablist"
                    >
                        <li class="nav-item" role="presentation">
                            <button
                                class="nav-link active"
                                id="sites-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#sites"
                                type="button"
                                role="tab"
                            >
                                <i class="bi bi-building"></i> Sites
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button
                                class="nav-link"
                                id="lieux-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#lieux"
                                type="button"
                                role="tab"
                            >
                                <i class="bi bi-geo-alt"></i> Lieux
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button
                                class="nav-link"
                                id="emplacements-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#emplacements"
                                type="button"
                                role="tab"
                            >
                                <i class="bi bi-box"></i> Emplacements
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button
                                class="nav-link"
                                id="hierarchy-tab"
                                data-bs-toggle="tab"
                                data-bs-target="#hierarchy"
                                type="button"
                                role="tab"
                            >
                                <i class="bi bi-diagram-3"></i> Vue Hiérarchique
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="hierarchyTabContent">
                        <!-- Onglet Sites -->
                        <div
                            class="tab-pane fade show active"
                            id="sites"
                            role="tabpanel"
                        >
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Code</th>
                                            <th>Nom du Site</th>
                                            <th>Ville</th>
                                            <th>Responsable</th>
                                            <th>Statut</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for site in sites %}
                                        <tr>
                                            <td>
                                                <code
                                                    >{{ site.code_site }}</code
                                                >
                                            </td>
                                            <td>
                                                <strong
                                                    >{{ site.nom_site }}</strong
                                                >
                                            </td>
                                            <td>{{ site.ville or '-' }}</td>
                                            <td>
                                                {{ site.responsable or '-' }}
                                            </td>
                                            <td>
                                                <span
                                                    class="badge bg-{{ 'success' if site.statut == 'Actif' else 'danger' }}"
                                                >
                                                    {{ site.statut }}
                                                </span>
                                            </td>
                                            <td>
                                                <div
                                                    class="btn-group btn-group-sm"
                                                >
                                                    <button
                                                        class="btn btn-outline-info"
                                                        onclick="modifierSite({{ site.id }})"
                                                        title="Modifier"
                                                    >
                                                        <i
                                                            class="bi bi-pencil"
                                                        ></i>
                                                    </button>
                                                    <button
                                                        class="btn btn-outline-danger"
                                                        onclick="supprimerSite({{ site.id }})"
                                                        title="Supprimer"
                                                    >
                                                        <i
                                                            class="bi bi-trash"
                                                        ></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Onglet Lieux -->
                        <div class="tab-pane fade" id="lieux" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Code</th>
                                            <th>Nom du Lieu</th>
                                            <th>Site</th>
                                            <th>Type</th>
                                            <th>Niveau</th>
                                            <th>Responsable</th>
                                            <th>Statut</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for lieu in lieux %}
                                        <tr>
                                            <td>
                                                <code
                                                    >{{ lieu.code_lieu }}</code
                                                >
                                            </td>
                                            <td>
                                                <strong
                                                    >{{ lieu.nom_lieu }}</strong
                                                >
                                            </td>
                                            <td>
                                                {% for site in sites %} {% if
                                                site.id == lieu.site_id %}
                                                <span class="badge bg-info"
                                                    >{{ site.nom_site }}</span
                                                >
                                                {% endif %} {% endfor %}
                                            </td>
                                            <td>{{ lieu.type_lieu or '-' }}</td>
                                            <td>{{ lieu.niveau or '-' }}</td>
                                            <td>
                                                {{ lieu.responsable or '-' }}
                                            </td>
                                            <td>
                                                <span
                                                    class="badge bg-{{ 'success' if lieu.statut == 'Actif' else 'danger' }}"
                                                >
                                                    {{ lieu.statut }}
                                                </span>
                                            </td>
                                            <td>
                                                <div
                                                    class="btn-group btn-group-sm"
                                                >
                                                    <button
                                                        class="btn btn-outline-info"
                                                        onclick="modifierLieu({{ lieu.id }})"
                                                        title="Modifier"
                                                    >
                                                        <i
                                                            class="bi bi-pencil"
                                                        ></i>
                                                    </button>
                                                    <button
                                                        class="btn btn-outline-danger"
                                                        onclick="supprimerLieu({{ lieu.id }})"
                                                        title="Supprimer"
                                                    >
                                                        <i
                                                            class="bi bi-trash"
                                                        ></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Onglet Emplacements -->
                        <div
                            class="tab-pane fade"
                            id="emplacements"
                            role="tabpanel"
                        >
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Code</th>
                                            <th>Nom</th>
                                            <th>Lieu</th>
                                            <th>Type</th>
                                            <th>Position</th>
                                            <th>Capacité</th>
                                            <th>Statut</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for emplacement in emplacements %}
                                        <tr>
                                            <td>
                                                <code
                                                    >{{
                                                    emplacement.code_emplacement
                                                    }}</code
                                                >
                                            </td>
                                            <td>
                                                <strong
                                                    >{{
                                                    emplacement.nom_emplacement
                                                    }}</strong
                                                >
                                            </td>
                                            <td>
                                                <span class="badge bg-success"
                                                    >{{ emplacement.lieu_nom or
                                                    '-' }}</span
                                                >
                                            </td>
                                            <td>
                                                {{ emplacement.type_emplacement
                                                or '-' }}
                                            </td>
                                            <td>
                                                {{ emplacement.position or '-'
                                                }}
                                            </td>
                                            <td>
                                                {{ emplacement.capacite_max }}
                                            </td>
                                            <td>
                                                <span
                                                    class="badge bg-{{ 'success' if emplacement.statut == 'Actif' else 'danger' }}"
                                                >
                                                    {{ emplacement.statut }}
                                                </span>
                                            </td>
                                            <td>
                                                <div
                                                    class="btn-group btn-group-sm"
                                                >
                                                    <button
                                                        class="btn btn-outline-info"
                                                        onclick="modifierEmplacement({{ emplacement.id }})"
                                                        title="Modifier"
                                                    >
                                                        <i
                                                            class="bi bi-pencil"
                                                        ></i>
                                                    </button>
                                                    <button
                                                        class="btn btn-outline-danger"
                                                        onclick="supprimerEmplacement({{ emplacement.id }})"
                                                        title="Supprimer"
                                                    >
                                                        <i
                                                            class="bi bi-trash"
                                                        ></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Onglet Vue Hiérarchique -->
                        <div
                            class="tab-pane fade"
                            id="hierarchy"
                            role="tabpanel"
                        >
                            <div class="row">
                                {% for site in sites %}
                                <div class="col-md-6 mb-4">
                                    <div class="card border-info">
                                        <div
                                            class="card-header bg-info text-white"
                                        >
                                            <h6 class="mb-0">
                                                <i class="bi bi-building"></i>
                                                {{ site.nom_site }}
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            {% set site_lieux =
                                            lieux|selectattr('site_id',
                                            'equalto', site.id)|list %} {% if
                                            site_lieux %} {% for lieu in
                                            site_lieux %}
                                            <div class="mb-3">
                                                <div
                                                    class="d-flex align-items-center mb-2"
                                                >
                                                    <i
                                                        class="bi bi-geo-alt text-success me-2"
                                                    ></i>
                                                    <strong
                                                        >{{ lieu.nom_lieu
                                                        }}</strong
                                                    >
                                                    {% if lieu.type_lieu %}
                                                    <span
                                                        class="badge bg-light text-dark ms-2"
                                                        >{{ lieu.type_lieu
                                                        }}</span
                                                    >
                                                    {% endif %}
                                                </div>
                                                {% set lieu_emplacements =
                                                emplacements|selectattr('lieu_id',
                                                'equalto', lieu.id)|list %} {%
                                                if lieu_emplacements %}
                                                <div class="ms-4">
                                                    {% for emplacement in
                                                    lieu_emplacements %}
                                                    <div
                                                        class="d-flex align-items-center mb-1"
                                                    >
                                                        <i
                                                            class="bi bi-box text-warning me-2"
                                                        ></i>
                                                        <span
                                                            >{{
                                                            emplacement.nom_emplacement
                                                            }}</span
                                                        >
                                                        {% if
                                                        emplacement.position %}
                                                        <small
                                                            class="text-muted ms-2"
                                                            >({{
                                                            emplacement.position
                                                            }})</small
                                                        >
                                                        {% endif %}
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                                {% else %}
                                                <div class="ms-4 text-muted">
                                                    <small
                                                        >Aucun
                                                        emplacement</small
                                                    >
                                                </div>
                                                {% endif %}
                                            </div>
                                            {% endfor %} {% else %}
                                            <p class="text-muted mb-0">
                                                Aucun lieu défini
                                            </p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nouveau Site -->
<div class="modal fade" id="nouveauSiteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-building text-info"></i> Nouveau Site
                </h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                ></button>
            </div>
            <form id="formNouveauSite">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Nom du Site *</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    name="nom_site"
                                    required
                                />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Ville</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    name="ville"
                                />
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Adresse</label>
                        <textarea
                            class="form-control"
                            name="adresse"
                            rows="2"
                        ></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Code Postal</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    name="code_postal"
                                />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Pays</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    name="pays"
                                    value="France"
                                />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Statut</label>
                                <select class="form-select" name="statut">
                                    <option value="Actif">Actif</option>
                                    <option value="Inactif">Inactif</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Responsable</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    name="responsable"
                                />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Téléphone</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    name="telephone"
                                />
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" name="email" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                    >
                        Annuler
                    </button>
                    <button type="submit" class="btn btn-info">
                        <i class="bi bi-check-circle"></i> Créer le Site
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Nouveau Lieu -->
<div class="modal fade" id="nouveauLieuModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-geo-alt text-success"></i> Nouveau Lieu
                </h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                ></button>
            </div>
            <form id="formNouveauLieu">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Site *</label>
                        <select class="form-select" name="site_id" required>
                            <option value="">Sélectionner un site</option>
                            {% for site in sites %}
                            <option value="{{ site.id }}">
                                {{ site.nom_site }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nom du Lieu *</label>
                        <input
                            type="text"
                            class="form-control"
                            name="nom_lieu"
                            required
                        />
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Type de Lieu</label>
                                <select class="form-select" name="type_lieu">
                                    <option value="">Sélectionner</option>
                                    <option value="Bâtiment">Bâtiment</option>
                                    <option value="Hangar">Hangar</option>
                                    <option value="Atelier">Atelier</option>
                                    <option value="Entrepôt">Entrepôt</option>
                                    <option value="Magasin">Magasin</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Niveau</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    name="niveau"
                                    placeholder="Ex: RDC, 1er étage"
                                />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Surface (m²)</label>
                                <input
                                    type="number"
                                    class="form-control"
                                    name="surface"
                                    step="0.01"
                                />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Statut</label>
                                <select class="form-select" name="statut">
                                    <option value="Actif">Actif</option>
                                    <option value="Inactif">Inactif</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Responsable</label>
                        <input
                            type="text"
                            class="form-control"
                            name="responsable"
                        />
                    </div>
                </div>
                <div class="modal-footer">
                    <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                    >
                        Annuler
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-circle"></i> Créer le Lieu
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Nouvel Emplacement -->
<div class="modal fade" id="nouvelEmplacementModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-box text-warning"></i> Nouvel Emplacement
                </h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                ></button>
            </div>
            <form id="formNouvelEmplacement">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Site *</label>
                                <select
                                    class="form-select"
                                    id="siteSelect"
                                    onchange="chargerLieux()"
                                    required
                                >
                                    <option value="">
                                        Sélectionner un site
                                    </option>
                                    {% for site in sites %}
                                    <option value="{{ site.id }}">
                                        {{ site.nom_site }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Lieu *</label>
                                <select
                                    class="form-select"
                                    name="lieu_id"
                                    id="lieuSelect"
                                    required
                                >
                                    <option value="">
                                        Sélectionner d'abord un site
                                    </option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nom de l'Emplacement *</label>
                        <input
                            type="text"
                            class="form-control"
                            name="nom_emplacement"
                            required
                        />
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label"
                                    >Type d'Emplacement</label
                                >
                                <select
                                    class="form-select"
                                    name="type_emplacement"
                                >
                                    <option value="">Sélectionner</option>
                                    <option value="Étagère">Étagère</option>
                                    <option value="Casier">Casier</option>
                                    <option value="Zone">Zone</option>
                                    <option value="Rack">Rack</option>
                                    <option value="Palette">Palette</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Position</label>
                                <input
                                    type="text"
                                    class="form-control"
                                    name="position"
                                    placeholder="Ex: A1, B2, C3"
                                />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Capacité Max</label>
                                <input
                                    type="number"
                                    class="form-control"
                                    name="capacite_max"
                                    value="100"
                                />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Temp. Min (°C)</label>
                                <input
                                    type="number"
                                    class="form-control"
                                    name="temperature_min"
                                    step="0.1"
                                />
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Temp. Max (°C)</label>
                                <input
                                    type="number"
                                    class="form-control"
                                    name="temperature_max"
                                    step="0.1"
                                />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label"
                                    >Humidité Max (%)</label
                                >
                                <input
                                    type="number"
                                    class="form-control"
                                    name="humidite_max"
                                    step="0.1"
                                />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Statut</label>
                                <select class="form-select" name="statut">
                                    <option value="Actif">Actif</option>
                                    <option value="Inactif">Inactif</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Conditions Spéciales</label>
                        <textarea
                            class="form-control"
                            name="conditions_speciales"
                            rows="2"
                            placeholder="Ex: Réfrigéré, Sec, Ventilé..."
                        ></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Responsable</label>
                        <input
                            type="text"
                            class="form-control"
                            name="responsable"
                        />
                    </div>
                </div>
                <div class="modal-footer">
                    <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                    >
                        Annuler
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-check-circle"></i> Créer l'Emplacement
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Variables globales
    let sites = {{ sites|tojson }};
    let lieux = {{ lieux|tojson }};
    let emplacements = {{ emplacements|tojson }};

    // Fonction pour charger les lieux d'un site
    function chargerLieux() {
        const siteId = document.getElementById('siteSelect').value;
        const lieuSelect = document.getElementById('lieuSelect');

        // Vider la liste des lieux
        lieuSelect.innerHTML = '<option value="">Sélectionner un lieu</option>';

        if (siteId) {
            // Filtrer les lieux du site sélectionné
            const lieuxDuSite = lieux.filter(lieu => lieu.site_id == siteId);

            lieuxDuSite.forEach(lieu => {
                const option = document.createElement('option');
                option.value = lieu.id;
                option.textContent = lieu.nom_lieu;
                lieuSelect.appendChild(option);
            });
        }
    }

    // Gestion des formulaires
    document.getElementById('formNouveauSite').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = Object.fromEntries(formData);

        try {
            const response = await fetch('/api/sites', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                alert('Site créé avec succès !');
                location.reload();
            } else {
                alert('Erreur : ' + result.message);
            }
        } catch (error) {
            alert('Erreur : ' + error.message);
        }
    });

    document.getElementById('formNouveauLieu').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = Object.fromEntries(formData);

        try {
            const response = await fetch('/api/lieux', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                alert('Lieu créé avec succès !');
                location.reload();
            } else {
                alert('Erreur : ' + result.message);
            }
        } catch (error) {
            alert('Erreur : ' + error.message);
        }
    });

    document.getElementById('formNouvelEmplacement').addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const data = Object.fromEntries(formData);

        try {
            const response = await fetch('/api/emplacements', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                alert('Emplacement créé avec succès !');
                location.reload();
            } else {
                alert('Erreur : ' + result.message);
            }
        } catch (error) {
            alert('Erreur : ' + error.message);
        }
    });

    // Fonctions de suppression
    async function supprimerSite(id) {
        if (confirm('Êtes-vous sûr de vouloir supprimer ce site ? Tous les lieux et emplacements associés seront également supprimés.')) {
            try {
                const response = await fetch(`/api/sites/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert('Site supprimé avec succès !');
                    location.reload();
                } else {
                    alert('Erreur : ' + result.message);
                }
            } catch (error) {
                alert('Erreur : ' + error.message);
            }
        }
    }

    async function supprimerLieu(id) {
        if (confirm('Êtes-vous sûr de vouloir supprimer ce lieu ? Tous les emplacements associés seront également supprimés.')) {
            try {
                const response = await fetch(`/api/lieux/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert('Lieu supprimé avec succès !');
                    location.reload();
                } else {
                    alert('Erreur : ' + result.message);
                }
            } catch (error) {
                alert('Erreur : ' + error.message);
            }
        }
    }

    async function supprimerEmplacement(id) {
        if (confirm('Êtes-vous sûr de vouloir supprimer cet emplacement ?')) {
            try {
                const response = await fetch(`/api/emplacements/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert('Emplacement supprimé avec succès !');
                    location.reload();
                } else {
                    alert('Erreur : ' + result.message);
                }
            } catch (error) {
                alert('Erreur : ' + error.message);
            }
        }
    }

    // Fonctions de modification (à implémenter)
    function modifierSite(id) {
        alert('Fonction de modification à implémenter');
    }

    function modifierLieu(id) {
        alert('Fonction de modification à implémenter');
    }

    function modifierEmplacement(id) {
        alert('Fonction de modification à implémenter');
    }
</script>

{% endblock %}
