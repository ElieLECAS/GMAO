{% extends "base.html" %} {% block title %}Gestion des Produits{% endblock %} {%
block content %}
<div class="container-fluid">
    <!-- En-t√™te -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="bi bi-box-seam text-primary"></i>
                        Gestion des Produits
                    </h1>
                    <p class="text-muted mb-0">
                        G√©rer les produits, fournisseurs et emplacements
                    </p>
                </div>
                <button
                    class="btn btn-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#nouveauProduitModal"
                >
                    <i class="bi bi-plus-circle"></i> Nouveau Produit
                </button>
            </div>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Total Produits</h6>
                            <h3 class="mb-0">{{ produits|length }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-box-seam fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Fournisseurs</h6>
                            <h3 class="mb-0">{{ fournisseurs|length }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-truck fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Emplacements</h6>
                            <h3 class="mb-0">{{ emplacements|length }}</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-geo-alt fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">Stock Critique</h6>
                            <h3 class="mb-0">
                                {% set critique_count = 0 %} {% for produit in
                                produits %} {% if (produit.quantite or 0) <
                                (produit.seuil_alerte or 0) %} {% set
                                critique_count = critique_count + 1 %} {% endif
                                %} {% endfor %} {{ critique_count }}
                            </h3>
                        </div>
                        <div class="align-self-center">
                            <i class="bi bi-exclamation-triangle fs-1"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtres et recherche -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Rechercher</label>
                            <input
                                type="text"
                                class="form-control"
                                id="searchInput"
                                placeholder="R√©f√©rence, nom, description..."
                            />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Fournisseur</label>
                            <select class="form-select" id="fournisseurFilter">
                                <option value="">Tous les fournisseurs</option>
                                {% for fournisseur in fournisseurs %}
                                <option value="{{ fournisseur.nom }}">
                                    {{ fournisseur.nom }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Emplacement</label>
                            <select class="form-select" id="emplacementFilter">
                                <option value="">Tous les emplacements</option>
                                {% for emplacement in emplacements %}
                                <option value="{{ emplacement.nom }}">
                                    {{ emplacement.nom }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">Statut Stock</label>
                            <select class="form-select" id="statutFilter">
                                <option value="">Tous</option>
                                <option value="critique">üî¥ Critique</option>
                                <option value="faible">üü† Faible</option>
                                <option value="normal">üü¢ Normal</option>
                                <option value="surstock">üü° Surstock</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tableau des produits -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-table"></i> Liste des Produits
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table
                            class="table table-hover mb-0"
                            id="produitsTable"
                        >
                            <thead class="table-light">
                                <tr>
                                    <th>R√©f√©rence</th>
                                    <th>Nom</th>
                                    <th>Description</th>
                                    <th>Stock</th>
                                    <th>Statut</th>
                                    <th>Fournisseur</th>
                                    <th>Emplacement</th>
                                    <th>Prix</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for produit in produits %}
                                <tr
                                    data-id="{{ produit.id }}"
                                    data-reference="{{ produit.reference }}"
                                    data-fournisseur="{{ produit.fournisseur or '' }}"
                                    data-emplacement="{{ produit.emplacement or '' }}"
                                    data-statut="{{ get_stock_status(produit) }}"
                                >
                                    <td>
                                        <strong class="text-primary"
                                            >{{ produit.reference }}</strong
                                        >
                                    </td>
                                    <td>
                                        {{ produit.produits or produit.nom or
                                        '-' }}
                                    </td>
                                    <td>
                                        <span class="text-muted">
                                            {{ (produit.description or '')[:50]
                                            }} {% if produit.description and
                                            produit.description|length > 50
                                            %}...{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary"
                                            >{{ produit.quantite or 0 }}</span
                                        >
                                        <small class="text-muted"
                                            >/ {{ produit.seuil_alerte or 0
                                            }}</small
                                        >
                                    </td>
                                    <td>
                                        <span
                                            class="badge bg-{{ 'danger' if get_stock_status(produit) == 'critique' else 'warning' if get_stock_status(produit) == 'faible' else 'success' if get_stock_status(produit) == 'normal' else 'info' }}"
                                        >
                                            {{ get_stock_status_text(produit) }}
                                        </span>
                                    </td>
                                    <td>{{ produit.fournisseur or '-' }}</td>
                                    <td>{{ produit.emplacement or '-' }}</td>
                                    <td>
                                        {% if produit.prix_unitaire %} {% set
                                        prix = produit.prix_unitaire|float %} {%
                                        if prix > 0 %} {{ "%.2f"|format(prix) }}
                                        ‚Ç¨ {% else %} - {% endif %} {% else %} -
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button
                                                class="btn btn-outline-primary"
                                                onclick="voirProduit('{{ produit.reference }}')"
                                                title="Voir d√©tails"
                                            >
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button
                                                class="btn btn-outline-warning"
                                                onclick="modifierProduit('{{ produit.reference }}')"
                                                title="Modifier"
                                            >
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button
                                                class="btn btn-outline-danger"
                                                onclick="supprimerProduit('{{ produit.reference }}')"
                                                title="Supprimer"
                                            >
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nouveau Produit -->
<div class="modal fade" id="nouveauProduitModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle text-primary"></i>
                    Nouveau Produit
                </h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                ></button>
            </div>
            <form id="nouveauProduitForm">
                <div class="modal-body">
                    <div class="row g-3">
                        <!-- Premi√®re ligne : R√©f√©rence fournisseur -->
                        <div class="col-md-6">
                            <label class="form-label"
                                >R√©f√©rence fournisseur</label
                            >
                            <input
                                type="text"
                                class="form-control"
                                name="reference_fournisseur"
                                placeholder="R√©f√©rence du fournisseur"
                            />
                        </div>
                        <div class="col-md-6">
                            <!-- Espace r√©serv√© pour √©quilibrer la mise en page -->
                        </div>

                        <!-- Deuxi√®me ligne : D√©signation -->
                        <div class="col-12">
                            <label class="form-label">D√©signation *</label>
                            <input
                                type="text"
                                class="form-control"
                                name="designation"
                                placeholder="Nom/d√©signation du produit"
                                required
                            />
                        </div>

                        <!-- Troisi√®me ligne : Description -->
                        <div class="col-12">
                            <label class="form-label">Description</label>
                            <textarea
                                class="form-control"
                                name="description"
                                rows="3"
                                placeholder="Description d√©taill√©e du produit"
                            ></textarea>
                        </div>

                        <!-- Quatri√®me ligne : Unit√©s -->
                        <div class="col-md-6">
                            <label class="form-label">Unit√© de stockage</label>
                            <select class="form-select" name="unite_stockage">
                                <option value="">S√©lectionner une unit√©</option>
                                <option value="PCE">PCE (Pi√®ce)</option>
                                <option value="BOITE 5">BOITE 5</option>
                                <option value="BOITE 10">BOITE 10</option>
                                <option value="par 1">par 1</option>
                                <option value="Boite 2000">Boite 2000</option>
                                <option value="kg">kg (Kilogramme)</option>
                                <option value="L">L (Litre)</option>
                                <option value="m">m (M√®tre)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Unit√© de commande</label>
                            <select class="form-select" name="unite_commande">
                                <option value="">S√©lectionner une unit√©</option>
                                <option value="BOITE 5">BOITE 5</option>
                                <option value="BOITE 10">BOITE 10</option>
                                <option value="par 1">par 1</option>
                                <option value="Boite 2000">Boite 2000</option>
                                <option value="PCE">PCE (Pi√®ce)</option>
                                <option value="kg">kg (Kilogramme)</option>
                                <option value="L">L (Litre)</option>
                                <option value="m">m (M√®tre)</option>
                            </select>
                        </div>

                        <!-- Cinqui√®me ligne : Stocks -->
                        <div class="col-md-4">
                            <label class="form-label">Quantit√© initiale</label>
                            <input
                                type="number"
                                class="form-control"
                                name="quantite"
                                value="0"
                                min="0"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label"
                                >Min (Seuil d'alerte)</label
                            >
                            <input
                                type="number"
                                class="form-control"
                                name="seuil_alerte"
                                value="5"
                                min="0"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label"
                                >Max (Stock maximum)</label
                            >
                            <input
                                type="number"
                                class="form-control"
                                name="stock_max"
                                value="100"
                                min="1"
                            />
                        </div>

                        <!-- Sixi√®me ligne : Site et Lieu -->
                        <div class="col-md-6">
                            <label class="form-label">Site</label>
                            <select class="form-select" name="site">
                                <option value="">S√©lectionner un site</option>
                                <option value="PROFERM">PROFERM</option>
                                <option value="AUTRE">AUTRE</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Lieu</label>
                            <select class="form-select" name="lieu">
                                <option value="">S√©lectionner un lieu</option>
                                <option value="MS3.0">MS3.0</option>
                                <option value="MS1.0">MS1.0</option>
                                <option value="AUTRE">AUTRE</option>
                            </select>
                        </div>

                        <!-- Septi√®me ligne : Emplacement et Fournisseur -->
                        <div class="col-md-6">
                            <label class="form-label">Emplacement</label>
                            <select class="form-select" name="emplacement">
                                <option value="">
                                    S√©lectionner un emplacement
                                </option>
                                <option value="E1">E1</option>
                                <option value="E2">E2</option>
                                <option value="E3">E3</option>
                                <option value="F21">F21</option>
                                <option value="G35">G35</option>
                                <option value="A11">A11</option>
                                {% for emplacement in emplacements %}
                                <option value="{{ emplacement.nom }}">
                                    {{ emplacement.nom }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"
                                >Fournisseur Standard</label
                            >
                            <select class="form-select" name="fournisseur">
                                <option value="">
                                    S√©lectionner un fournisseur
                                </option>
                                <option value="BOSCHAT">BOSCHAT</option>
                                <option value="FAILLE">FAILLE</option>
                                <option value="SFS">SFS</option>
                                {% for fournisseur in fournisseurs %}
                                <option value="{{ fournisseur.nom }}">
                                    {{ fournisseur.nom }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Huiti√®me ligne : Prix et Cat√©gorie -->
                        <div class="col-md-4">
                            <label class="form-label">Prix unitaire (‚Ç¨)</label>
                            <input
                                type="number"
                                class="form-control"
                                name="prix_unitaire"
                                step="0.01"
                                min="0"
                                placeholder="0,00"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Cat√©gorie</label>
                            <select class="form-select" name="categorie">
                                <option value="">
                                    S√©lectionner une cat√©gorie
                                </option>
                                <option value="Ferrure">Ferrure</option>
                                <option value="VISSERIE">VISSERIE</option>
                                <option value="AUTRE">AUTRE</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Secteur</label>
                            <select class="form-select" name="secteur">
                                <option value="">
                                    S√©lectionner un secteur
                                </option>
                                <option value="PVC">PVC</option>
                                <option value="ALU">ALU</option>
                                <option value="AUTRE">AUTRE</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                    >
                        Annuler
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Cr√©er le produit
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Modifier Produit -->
<div class="modal fade" id="modifierProduitModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-pencil text-warning"></i>
                    Modifier Produit
                </h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                ></button>
            </div>
            <form id="modifierProduitForm">
                <div class="modal-body">
                    <input
                        type="hidden"
                        name="reference_originale"
                        id="referenceOriginale"
                    />
                    <div class="row g-3">
                        <!-- Premi√®re ligne : R√©f√©rence fournisseur -->
                        <div class="col-md-6">
                            <label class="form-label"
                                >R√©f√©rence fournisseur</label
                            >
                            <input
                                type="text"
                                class="form-control"
                                name="reference_fournisseur"
                                id="modifReferenceFournisseur"
                                placeholder="R√©f√©rence du fournisseur"
                            />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"
                                >Code QR (g√©n√©r√© automatiquement)</label
                            >
                            <input
                                type="text"
                                class="form-control"
                                id="modifReference"
                                readonly
                                placeholder="G√©n√©r√© automatiquement"
                            />
                            <small class="text-muted"
                                >Code √† 10 chiffres g√©n√©r√© lors de la
                                cr√©ation</small
                            >
                        </div>

                        <!-- Deuxi√®me ligne : D√©signation -->
                        <div class="col-12">
                            <label class="form-label">D√©signation *</label>
                            <input
                                type="text"
                                class="form-control"
                                name="designation"
                                id="modifDesignation"
                                placeholder="Nom/d√©signation du produit"
                                required
                            />
                        </div>

                        <!-- Troisi√®me ligne : Description -->
                        <div class="col-12">
                            <label class="form-label">Description</label>
                            <textarea
                                class="form-control"
                                name="description"
                                id="modifDescription"
                                rows="3"
                                placeholder="Description d√©taill√©e du produit"
                            ></textarea>
                        </div>

                        <!-- Quatri√®me ligne : Unit√©s -->
                        <div class="col-md-6">
                            <label class="form-label">Unit√© de stockage</label>
                            <select
                                class="form-select"
                                name="unite_stockage"
                                id="modifUniteStockage"
                            >
                                <option value="">S√©lectionner une unit√©</option>
                                <option value="PCE">PCE (Pi√®ce)</option>
                                <option value="BOITE 5">BOITE 5</option>
                                <option value="BOITE 10">BOITE 10</option>
                                <option value="par 1">par 1</option>
                                <option value="Boite 2000">Boite 2000</option>
                                <option value="kg">kg (Kilogramme)</option>
                                <option value="L">L (Litre)</option>
                                <option value="m">m (M√®tre)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Unit√© de commande</label>
                            <select
                                class="form-select"
                                name="unite_commande"
                                id="modifUniteCommande"
                            >
                                <option value="">S√©lectionner une unit√©</option>
                                <option value="BOITE 5">BOITE 5</option>
                                <option value="BOITE 10">BOITE 10</option>
                                <option value="par 1">par 1</option>
                                <option value="Boite 2000">Boite 2000</option>
                                <option value="PCE">PCE (Pi√®ce)</option>
                                <option value="kg">kg (Kilogramme)</option>
                                <option value="L">L (Litre)</option>
                                <option value="m">m (M√®tre)</option>
                            </select>
                        </div>

                        <!-- Cinqui√®me ligne : Stocks -->
                        <div class="col-md-4">
                            <label class="form-label"
                                >Min (Seuil d'alerte)</label
                            >
                            <input
                                type="number"
                                class="form-control"
                                name="seuil_alerte"
                                id="modifSeuilAlerte"
                                min="0"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label"
                                >Max (Stock maximum)</label
                            >
                            <input
                                type="number"
                                class="form-control"
                                name="stock_max"
                                id="modifStockMax"
                                min="1"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Quantit√© actuelle</label>
                            <input
                                type="number"
                                class="form-control"
                                id="modifQuantite"
                                readonly
                            />
                            <small class="text-muted"
                                >Utilisez les mouvements de stock pour
                                modifier</small
                            >
                        </div>

                        <!-- Sixi√®me ligne : Site et Lieu -->
                        <div class="col-md-6">
                            <label class="form-label">Site</label>
                            <select
                                class="form-select"
                                name="site"
                                id="modifSite"
                            >
                                <option value="">S√©lectionner un site</option>
                                <option value="PROFERM">PROFERM</option>
                                <option value="AUTRE">AUTRE</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Lieu</label>
                            <select
                                class="form-select"
                                name="lieu"
                                id="modifLieu"
                            >
                                <option value="">S√©lectionner un lieu</option>
                                <option value="MS3.0">MS3.0</option>
                                <option value="MS1.0">MS1.0</option>
                                <option value="AUTRE">AUTRE</option>
                            </select>
                        </div>

                        <!-- Septi√®me ligne : Emplacement et Fournisseur -->
                        <div class="col-md-6">
                            <label class="form-label">Emplacement</label>
                            <select
                                class="form-select"
                                name="emplacement"
                                id="modifEmplacement"
                            >
                                <option value="">
                                    S√©lectionner un emplacement
                                </option>
                                <option value="E1">E1</option>
                                <option value="E2">E2</option>
                                <option value="E3">E3</option>
                                <option value="F21">F21</option>
                                <option value="G35">G35</option>
                                <option value="A11">A11</option>
                                {% for emplacement in emplacements %}
                                <option value="{{ emplacement.nom }}">
                                    {{ emplacement.nom }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label"
                                >Fournisseur Standard</label
                            >
                            <select
                                class="form-select"
                                name="fournisseur"
                                id="modifFournisseur"
                            >
                                <option value="">
                                    S√©lectionner un fournisseur
                                </option>
                                <option value="BOSCHAT">BOSCHAT</option>
                                <option value="FAILLE">FAILLE</option>
                                <option value="SFS">SFS</option>
                                {% for fournisseur in fournisseurs %}
                                <option value="{{ fournisseur.nom }}">
                                    {{ fournisseur.nom }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Huiti√®me ligne : Prix et Cat√©gorie -->
                        <div class="col-md-4">
                            <label class="form-label">Prix unitaire (‚Ç¨)</label>
                            <input
                                type="number"
                                class="form-control"
                                name="prix_unitaire"
                                id="modifPrixUnitaire"
                                step="0.01"
                                min="0"
                                placeholder="0,00"
                            />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Cat√©gorie</label>
                            <select
                                class="form-select"
                                name="categorie"
                                id="modifCategorie"
                            >
                                <option value="">
                                    S√©lectionner une cat√©gorie
                                </option>
                                <option value="Ferrure">Ferrure</option>
                                <option value="VISSERIE">VISSERIE</option>
                                <option value="AUTRE">AUTRE</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Secteur</label>
                            <select
                                class="form-select"
                                name="secteur"
                                id="modifSecteur"
                            >
                                <option value="">
                                    S√©lectionner un secteur
                                </option>
                                <option value="PVC">PVC</option>
                                <option value="ALU">ALU</option>
                                <option value="AUTRE">AUTRE</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button
                        type="button"
                        class="btn btn-secondary"
                        data-bs-dismiss="modal"
                    >
                        Annuler
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-check-circle"></i> Modifier le produit
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Recherche et filtres
        const searchInput = document.getElementById("searchInput");
        const fournisseurFilter = document.getElementById("fournisseurFilter");
        const emplacementFilter = document.getElementById("emplacementFilter");
        const statutFilter = document.getElementById("statutFilter");
        const table = document.getElementById("produitsTable");
        const rows = table.querySelectorAll("tbody tr");

        function filterTable() {
            const searchTerm = searchInput.value.toLowerCase();
            const fournisseurValue = fournisseurFilter.value;
            const emplacementValue = emplacementFilter.value;
            const statutValue = statutFilter.value;

            rows.forEach((row) => {
                const reference = row.cells[0].textContent.toLowerCase();
                const nom = row.cells[1].textContent.toLowerCase();
                const description = row.cells[2].textContent.toLowerCase();
                const fournisseur = row.dataset.fournisseur;
                const emplacement = row.dataset.emplacement;
                const statut = row.dataset.statut;

                const matchSearch =
                    !searchTerm ||
                    reference.includes(searchTerm) ||
                    nom.includes(searchTerm) ||
                    description.includes(searchTerm);

                const matchFournisseur =
                    !fournisseurValue || fournisseur === fournisseurValue;
                const matchEmplacement =
                    !emplacementValue || emplacement === emplacementValue;
                const matchStatut = !statutValue || statut === statutValue;

                if (
                    matchSearch &&
                    matchFournisseur &&
                    matchEmplacement &&
                    matchStatut
                ) {
                    row.style.display = "";
                } else {
                    row.style.display = "none";
                }
            });
        }

        searchInput.addEventListener("input", filterTable);
        fournisseurFilter.addEventListener("change", filterTable);
        emplacementFilter.addEventListener("change", filterTable);
        statutFilter.addEventListener("change", filterTable);

        // Formulaire nouveau produit
        document
            .getElementById("nouveauProduitForm")
            .addEventListener("submit", function (e) {
                e.preventDefault();

                const formData = new FormData(this);
                const data = Object.fromEntries(formData.entries());

                // Validation
                if (!data.designation) {
                    alert("Veuillez remplir la d√©signation du produit");
                    return;
                }

                // Appel API pour cr√©er le produit
                fetch("/api/produits", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                })
                    .then((response) => response.json())
                    .then((result) => {
                        if (result.success) {
                            alert("Produit cr√©√© avec succ√®s !");
                            bootstrap.Modal.getInstance(
                                document.getElementById("nouveauProduitModal")
                            ).hide();
                            location.reload();
                        } else {
                            alert("Erreur: " + result.message);
                        }
                    })
                    .catch((error) => {
                        console.error("Erreur:", error);
                        alert("Erreur lors de la cr√©ation du produit");
                    });
            });

        // Formulaire modifier produit
        document
            .getElementById("modifierProduitForm")
            .addEventListener("submit", function (e) {
                e.preventDefault();

                const formData = new FormData(this);
                const data = Object.fromEntries(formData.entries());

                // Validation
                if (!data.designation) {
                    alert("Veuillez remplir la d√©signation du produit");
                    return;
                }

                // R√©cup√©rer l'ID du produit depuis les donn√©es stock√©es
                const produitId = window.currentProduitId;
                if (!produitId) {
                    alert("Erreur: ID du produit non trouv√©");
                    return;
                }

                // Appel API pour modifier le produit
                fetch(`/api/produits/${produitId}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                })
                    .then((response) => response.json())
                    .then((result) => {
                        if (result.success) {
                            alert("Produit modifi√© avec succ√®s !");
                            bootstrap.Modal.getInstance(
                                document.getElementById("modifierProduitModal")
                            ).hide();
                            location.reload();
                        } else {
                            alert("Erreur: " + result.message);
                        }
                    })
                    .catch((error) => {
                        console.error("Erreur:", error);
                        alert("Erreur lors de la modification du produit");
                    });
            });
    });

    function voirProduit(reference) {
        // Rediriger vers la page de d√©tail du produit
        window.location.href = `/produit/${reference}`;
    }

    function modifierProduit(reference) {
        // R√©cup√©rer les donn√©es du produit via API
        fetch(`/api/produits/${reference}`)
            .then((response) => response.json())
            .then((result) => {
                if (result.success) {
                    const produit = result.produit;

                    // Stocker l'ID du produit pour la modification
                    window.currentProduitId = produit.id;

                    // Remplir le formulaire de modification
                    document.getElementById("referenceOriginale").value =
                        reference;
                    document.getElementById("modifReference").value =
                        produit.reference;
                    document.getElementById("modifReferenceFournisseur").value =
                        produit.reference_fournisseur || "";
                    document.getElementById("modifDesignation").value =
                        produit.designation ||
                        produit.nom ||
                        produit.produits ||
                        "";
                    document.getElementById("modifDescription").value =
                        produit.description || "";

                    // Extraire la description si elle est dans le champ produits
                    if (produit.produits && produit.produits.includes(" - ")) {
                        const parts = produit.produits.split(" - ");
                        document.getElementById("modifDesignation").value =
                            parts[0];
                        document.getElementById("modifDescription").value =
                            parts.slice(1).join(" - ");
                    }

                    document.getElementById("modifUniteStockage").value =
                        produit.unite_stockage || "";
                    document.getElementById("modifUniteCommande").value =
                        produit.unite_commande || "";
                    document.getElementById("modifSeuilAlerte").value =
                        produit.stock_min || produit.seuil_alerte || 0;
                    document.getElementById("modifStockMax").value =
                        produit.stock_max || 100;
                    document.getElementById("modifQuantite").value =
                        produit.quantite || 0;
                    document.getElementById("modifSite").value =
                        produit.site || "";
                    document.getElementById("modifLieu").value =
                        produit.lieu || "";
                    document.getElementById("modifEmplacement").value =
                        produit.emplacement || "";
                    document.getElementById("modifFournisseur").value =
                        produit.fournisseur || "";
                    document.getElementById("modifPrixUnitaire").value =
                        produit.prix_unitaire || "";
                    document.getElementById("modifCategorie").value =
                        produit.categorie || "";
                    document.getElementById("modifSecteur").value =
                        produit.secteur || "";

                    // Afficher le modal
                    new bootstrap.Modal(
                        document.getElementById("modifierProduitModal")
                    ).show();
                } else {
                    alert("Erreur: " + result.message);
                }
            })
            .catch((error) => {
                console.error("Erreur:", error);
                alert("Erreur lors de la r√©cup√©ration des donn√©es du produit");
            });
    }

    function supprimerProduit(reference) {
        if (
            confirm(
                `√ätes-vous s√ªr de vouloir supprimer le produit ${reference} ?\n\nCette action est irr√©versible.`
            )
        ) {
            // R√©cup√©rer l'ID depuis le tableau
            const row = document.querySelector(
                `tr[data-reference="${reference}"]`
            );
            const produitId = row ? row.dataset.id : null;

            if (!produitId) {
                alert("Erreur: ID du produit non trouv√©");
                return;
            }

            // Appel API pour supprimer le produit
            fetch(`/api/produits/${produitId}`, {
                method: "DELETE",
            })
                .then((response) => response.json())
                .then((result) => {
                    if (result.success) {
                        alert("Produit supprim√© avec succ√®s !");
                        location.reload();
                    } else {
                        alert("Erreur: " + result.message);
                    }
                })
                .catch((error) => {
                    console.error("Erreur:", error);
                    alert("Erreur lors de la suppression du produit");
                });
        }
    }
</script>

<style>
    .status-critique {
        background-color: #f8d7da;
    }
    .status-faible {
        background-color: #fff3cd;
    }
    .status-normal {
        background-color: #d1e7dd;
    }
    .status-surstock {
        background-color: #cff4fc;
    }

    .table-responsive {
        max-height: 600px;
        overflow-y: auto;
    }

    .btn-group-sm .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }
</style>
{% endblock %}
