{% extends "base.html" %} {% block title %}{{ produit.nom or produit.reference
}} - GMAO Mobile{% endblock %} {% block content %}
<div class="row justify-content-center">
    <div class="col-12 col-md-8 col-lg-6">
        <!-- En-tête avec retour -->
        <div class="d-flex align-items-center mb-4">
            <button
                onclick="history.back()"
                class="btn btn-outline-secondary me-3"
            >
                <i class="bi bi-arrow-left"></i>
            </button>
            <h4 class="mb-0">Détail produit</h4>
        </div>

        <!-- Carte principale du produit -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">{{ produit.nom or produit.reference }}</h5>
                    {% set stock_class = 'bg-danger' if (produit.quantite or 0)
                    <= (produit.seuil_alerte or 0) else 'bg-warning text-dark'
                    if (produit.quantite or 0) <= (produit.seuil_alerte or 0) *
                    2 else 'bg-success' %}
                    <span class="badge {{ stock_class }} fs-6"
                        >{{ produit.quantite or 0 }}</span
                    >
                </div>
            </div>
            <div class="card-body">
                <!-- Informations principales -->
                <div class="row mb-3">
                    <div class="col-6">
                        <strong>Nom:</strong><br />
                        <span class="text-muted"
                            >{{ produit.produits or produit.nom or '-' }}</span
                        >
                    </div>
                    <div class="col-6">
                        <strong>Référence:</strong><br />
                        <span class="text-muted">{{ produit.reference }}</span>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-6">
                        <strong>Code:</strong><br />
                        <span class="text-muted"
                            >{{ produit.code or '-' }}</span
                        >
                    </div>
                    <div class="col-6">
                        <strong>Référence fournisseur:</strong><br />
                        <span class="text-muted"
                            >{{ produit.reference_fournisseur or '-' }}</span
                        >
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-6">
                        <strong>Emplacement:</strong><br />
                        <span class="text-muted"
                            >{{ produit.emplacement or '-' }}</span
                        >
                    </div>
                    <div class="col-6">
                        <strong>Fournisseur:</strong><br />
                        <span class="text-muted"
                            >{{ produit.fournisseur or '-' }}</span
                        >
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-6">
                        <strong>Site:</strong><br />
                        <span class="text-muted"
                            >{{ produit.site or '-' }}</span
                        >
                    </div>
                    <div class="col-6">
                        <strong>Lieu:</strong><br />
                        <span class="text-muted"
                            >{{ produit.lieu or '-' }}</span
                        >
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-6">
                        <strong>Catégorie:</strong><br />
                        <span class="text-muted"
                            >{{ produit.categorie or '-' }}</span
                        >
                    </div>
                    <div class="col-6">
                        <strong>Secteur:</strong><br />
                        <span class="text-muted"
                            >{{ produit.secteur or '-' }}</span
                        >
                    </div>
                </div>

                <!-- Informations de stock -->
                <hr class="my-4" />
                <h6 class="text-primary mb-3">
                    <i class="bi bi-box-seam"></i> Informations de stock
                </h6>

                <div class="row mb-3">
                    <div class="col-6">
                        <strong>Stock minimum:</strong><br />
                        <span class="text-muted"
                            >{{ produit.stock_min or produit.seuil_alerte or 0
                            }}</span
                        >
                    </div>
                    <div class="col-6">
                        <strong>Stock maximum:</strong><br />
                        <span class="text-muted"
                            >{{ produit.stock_max or 100 }}</span
                        >
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-6">
                        <strong>Unité de stockage:</strong><br />
                        <span class="text-muted"
                            >{{ produit.unite_stockage or 'Non définie' }}</span
                        >
                    </div>
                    <div class="col-6">
                        <strong>Unité de commande:</strong><br />
                        <span class="text-muted"
                            >{{ produit.unite_commande or 'Non définie' }}</span
                        >
                    </div>
                </div>

                <!-- Informations financières -->
                <hr class="my-4" />
                <h6 class="text-success mb-3">
                    <i class="bi bi-currency-euro"></i> Informations financières
                </h6>

                <div class="row mb-3">
                    <div class="col-6">
                        <strong>Prix unitaire:</strong><br />
                        <span class="text-muted">
                            {% if produit.prix_unitaire %} {% set prix =
                            produit.prix_unitaire|float %} {% if prix > 0 %} {{
                            "%.2f"|format(prix) }} € {% else %} Non défini {%
                            endif %} {% else %} Non défini {% endif %}
                        </span>
                    </div>
                    <div class="col-6">
                        <strong>Valeur du stock:</strong><br />
                        <span class="text-muted">
                            {% if produit.prix_unitaire %} {% set prix =
                            produit.prix_unitaire|float %} {% set quantite =
                            produit.quantite or 0 %} {% if prix > 0 %} {{
                            "%.2f"|format(prix * quantite) }} € {% else %} Non
                            calculable {% endif %} {% else %} Non calculable {%
                            endif %}
                        </span>
                    </div>
                </div>

                <!-- Informations de traçabilité -->
                <hr class="my-4" />
                <h6 class="text-info mb-3">
                    <i class="bi bi-clock-history"></i> Traçabilité
                </h6>

                <div class="row mb-3">
                    <div class="col-6">
                        <strong>Date d'entrée:</strong><br />
                        <span class="text-muted">
                            {% if produit.date_entree %} {{ produit.date_entree
                            }} {% else %} Non définie {% endif %}
                        </span>
                    </div>
                    <div class="col-6">
                        <strong>Dernière mise à jour:</strong><br />
                        <span class="text-muted">
                            {% if produit.updated_at %} {% if
                            produit.updated_at.strftime is defined %} {{
                            produit.updated_at.strftime('%d/%m/%Y %H:%M') }} {%
                            else %} {{ produit.updated_at }} {% endif %} {% else
                            %} Non définie {% endif %}
                        </span>
                    </div>
                </div>

                <!-- Statut du stock -->
                <div
                    class="alert {% if (produit.quantite or 0) <= (produit.seuil_alerte or 0) %}alert-danger{% elif (produit.quantite or 0) <= (produit.seuil_alerte or 0) * 2 %}alert-warning{% else %}alert-success{% endif %}"
                >
                    <i
                        class="bi bi-{% if (produit.quantite or 0) <= (produit.seuil_alerte or 0) %}exclamation-triangle{% elif (produit.quantite or 0) <= (produit.seuil_alerte or 0) * 2 %}exclamation-circle{% else %}check-circle{% endif %}"
                    ></i>
                    {% if (produit.quantite or 0) <= (produit.seuil_alerte or 0)
                    %}
                    <strong>Stock critique!</strong> Réapprovisionnement urgent
                    nécessaire. {% elif (produit.quantite or 0) <=
                    (produit.seuil_alerte or 0) * 2 %}
                    <strong>Stock faible.</strong> Prévoir un
                    réapprovisionnement. {% else %}
                    <strong>Stock suffisant.</strong>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- QR Code -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-qr-code"></i> QR Code</h6>
            </div>
            <div class="card-body text-center">
                <img
                    src="{{ qr_code }}"
                    alt="QR Code"
                    class="img-fluid mb-3"
                    style="max-width: 200px"
                />
                <p class="text-muted small">{{ produit.reference }}</p>
                <button
                    class="btn btn-outline-primary btn-sm"
                    onclick="downloadQR()"
                >
                    <i class="bi bi-download"></i> Télécharger
                </button>
                <button
                    class="btn btn-outline-secondary btn-sm"
                    onclick="shareQR()"
                >
                    <i class="bi bi-share"></i> Partager
                </button>
            </div>
        </div>

        <!-- Actions rapides -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-lightning-charge"></i> Actions rapides
                </h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button
                        class="btn btn-success"
                        onclick="showMovementModal('entree')"
                    >
                        <i class="bi bi-plus-circle"></i> Entrée de stock
                    </button>
                    <button
                        class="btn btn-warning"
                        onclick="showMovementModal('sortie')"
                    >
                        <i class="bi bi-dash-circle"></i> Sortie de stock
                    </button>
                    <button
                        class="btn btn-info"
                        onclick="showMovementModal('inventaire')"
                    >
                        <i class="bi bi-clipboard-check"></i> Correction
                        inventaire
                    </button>
                    <a
                        href="{{ url_for('nouvelle_demande') }}?produit={{ produit.reference }}"
                        class="btn btn-outline-primary"
                    >
                        <i class="bi bi-clipboard-plus"></i> Créer une demande
                    </a>
                </div>
            </div>
        </div>

        <!-- Statistiques du produit -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="bi bi-graph-up"></i> Statistiques
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-3">
                        <div class="border rounded p-3">
                            <h5 class="text-primary mb-1">
                                {{ produit.quantite or 0 }}
                            </h5>
                            <small class="text-muted">Stock actuel</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="border rounded p-3">
                            <h5 class="text-warning mb-1">
                                {{ produit.stock_min or produit.seuil_alerte or
                                0 }}
                            </h5>
                            <small class="text-muted">Seuil minimum</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="border rounded p-3">
                            <h5 class="text-success mb-1">
                                {{ produit.stock_max or 100 }}
                            </h5>
                            <small class="text-muted">Stock maximum</small>
                        </div>
                    </div>
                    <div class="col-3">
                        <div class="border rounded p-3">
                            <h5 class="text-info mb-1" id="rotation-stock">
                                -
                            </h5>
                            <small class="text-muted">Rotation (30j)</small>
                        </div>
                    </div>
                </div>

                <!-- Barre de progression du stock -->
                <div class="mt-3">
                    <label class="form-label small">Niveau de stock</label>
                    {% set stock_min = produit.stock_min or produit.seuil_alerte
                    or 0 %} {% set stock_max = produit.stock_max or 100 %} {%
                    set stock_actuel = produit.quantite or 0 %} {% set
                    pourcentage = ((stock_actuel / stock_max) * 100) if
                    stock_max > 0 else 0 %}

                    <div class="progress" style="height: 20px">
                        <div
                            class="progress-bar {% if stock_actuel <= stock_min %}bg-danger {% elif stock_actuel <= stock_min * 2 %}bg-warning {% else %}bg-success{% endif %}"
                            role="progressbar"
                            style="width: {{ pourcentage }}%"
                            aria-valuenow="{{ stock_actuel }}"
                            aria-valuemin="0"
                            aria-valuemax="{{ stock_max }}"
                        >
                            {{ stock_actuel }} / {{ stock_max }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Historique récent -->
        <div class="card">
            <div
                class="card-header d-flex justify-content-between align-items-center"
            >
                <h6 class="mb-0">
                    <i class="bi bi-clock-history"></i> Historique récent
                </h6>
                <a
                    href="{{ url_for('historique_mouvements') }}?reference={{ produit.reference }}"
                    class="btn btn-outline-primary btn-sm"
                >
                    <i class="bi bi-list"></i> Voir tout
                </a>
            </div>
            <div class="card-body">
                <div id="historique-container">
                    <div class="text-center">
                        <div class="spinner-border spinner-border-sm"></div>
                        <span class="ms-2">Chargement...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de mouvement de stock -->
<div class="modal fade" id="movementModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="movementModalTitle">
                    Mouvement de stock
                </h5>
                <button
                    type="button"
                    class="btn-close"
                    data-bs-dismiss="modal"
                ></button>
            </div>
            <div class="modal-body">
                <form id="movementForm">
                    <input
                        type="hidden"
                        id="movement-reference"
                        value="{{ produit.reference }}"
                    />
                    <input type="hidden" id="movement-nature" />

                    <div class="mb-3">
                        <label class="form-label">Produit</label>
                        <input
                            type="text"
                            class="form-control"
                            value="{{ produit.nom or produit.reference }}"
                            readonly
                        />
                    </div>

                    <div class="mb-3">
                        <label for="movement-quantity" class="form-label"
                            >Quantité</label
                        >
                        <div class="input-group">
                            <button
                                type="button"
                                class="btn btn-outline-secondary"
                                onclick="adjustQuantity(-1)"
                            >
                                <i class="bi bi-dash"></i>
                            </button>
                            <input
                                type="number"
                                class="form-control text-center"
                                id="movement-quantity"
                                min="1"
                                value="1"
                                required
                            />
                            <button
                                type="button"
                                class="btn btn-outline-secondary"
                                onclick="adjustQuantity(1)"
                            >
                                <i class="bi bi-plus"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="movement-user" class="form-label"
                            >Utilisateur</label
                        >
                        <input
                            type="text"
                            class="form-control"
                            id="movement-user"
                            placeholder="Votre nom"
                            required
                        />
                    </div>

                    <div class="mb-3">
                        <label for="movement-comments" class="form-label"
                            >Commentaires (optionnel)</label
                        >
                        <textarea
                            class="form-control"
                            id="movement-comments"
                            rows="3"
                            placeholder="Raison du mouvement..."
                        ></textarea>
                    </div>

                    <div class="alert alert-info" id="stock-preview">
                        <small>Stock actuel: {{ produit.quantite or 0 }}</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button
                    type="button"
                    class="btn btn-secondary"
                    data-bs-dismiss="modal"
                >
                    Annuler
                </button>
                <button
                    type="button"
                    class="btn btn-primary"
                    onclick="submitMovement()"
                >
                    <span id="submit-btn-text">Confirmer</span>
                    <span
                        id="submit-btn-spinner"
                        class="spinner-border spinner-border-sm d-none"
                    ></span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %} {% block extra_js %}
<script>
    let currentStock = {{ produit.quantite or 0 }};

    document.addEventListener('DOMContentLoaded', function() {
        loadHistorique();
    });

    function loadHistorique() {
        fetch(`/historique/reference/{{ produit.reference }}`)
            .then(response => response.json())
            .then(historique => {
                const container = document.getElementById('historique-container');

                if (historique && historique.length > 0) {
                    let html = '';
                    let totalMouvements30j = 0;
                    const date30jAgo = new Date();
                    date30jAgo.setDate(date30jAgo.getDate() - 30);

                    historique.slice(0, 5).forEach(mouvement => {
                        const dateMouvement = new Date(mouvement.date_mouvement);
                        const dateFormatted = dateMouvement.toLocaleString('fr-FR');

                        // Calculer la rotation sur 30 jours
                        if (dateMouvement >= date30jAgo && (mouvement.nature === 'Sortie' || mouvement.nature === 'sortie')) {
                            totalMouvements30j += mouvement.quantite_mouvement || mouvement.quantite || 0;
                        }

                        const icon = (mouvement.nature === 'Entrée' || mouvement.nature === 'entree') ? 'plus-circle text-success' :
                                    (mouvement.nature === 'Sortie' || mouvement.nature === 'sortie') ? 'dash-circle text-danger' :
                                    'clipboard-check text-info';

                        const natureDisplay = mouvement.nature === 'Entrée' || mouvement.nature === 'entree' ? 'Entrée' :
                                            mouvement.nature === 'Sortie' || mouvement.nature === 'sortie' ? 'Sortie' :
                                            'Ajustement';

                        html += `
                            <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                                <div>
                                    <i class="bi bi-${icon}"></i>
                                    <strong>${natureDisplay}</strong>
                                    <span class="text-muted">- ${mouvement.quantite_mouvement || mouvement.quantite || 0}</span>
                                    <br>
                                    <small class="text-muted">${dateFormatted}</small>
                                </div>
                                <div class="text-end">
                                    <div class="badge bg-secondary">${mouvement.quantite_apres || 'N/A'}</div>
                                    <br>
                                    <small class="text-muted">Stock après</small>
                                </div>
                            </div>
                        `;
                    });

                    container.innerHTML = html;

                    // Mettre à jour la rotation
                    document.getElementById('rotation-stock').textContent = totalMouvements30j;
                } else {
                    container.innerHTML = '<div class="text-muted text-center py-3"><i class="bi bi-inbox"></i><br>Aucun mouvement récent</div>';
                    document.getElementById('rotation-stock').textContent = '0';
                }
            })
            .catch(error => {
                console.error('Erreur lors du chargement de l\'historique:', error);
                document.getElementById('historique-container').innerHTML =
                    '<div class="text-danger text-center py-3"><i class="bi bi-exclamation-triangle"></i><br>Erreur lors du chargement</div>';
                document.getElementById('rotation-stock').textContent = '-';
            });
    }

    function showMovementModal(nature) {
        const modal = new bootstrap.Modal(document.getElementById('movementModal'));
        const title = document.getElementById('movementModalTitle');
        const natureInput = document.getElementById('movement-nature');

        natureInput.value = nature;

        switch(nature) {
            case 'entree':
                title.textContent = 'Entrée de stock';
                break;
            case 'sortie':
                title.textContent = 'Sortie de stock';
                break;
            case 'inventaire':
                title.textContent = 'Correction inventaire';
                break;
        }

        // Reset form
        document.getElementById('movement-quantity').value = 1;
        document.getElementById('movement-comments').value = '';
        updateStockPreview();

        modal.show();
    }

    function adjustQuantity(delta) {
        const input = document.getElementById('movement-quantity');
        const newValue = parseInt(input.value) + delta;
        if (newValue >= 1) {
            input.value = newValue;
            updateStockPreview();
        }
    }

    function updateStockPreview() {
        const quantity = parseInt(document.getElementById('movement-quantity').value) || 0;
        const nature = document.getElementById('movement-nature').value;
        const preview = document.getElementById('stock-preview');

        let newStock = currentStock;
        if (nature === 'entree') {
            newStock += quantity;
        } else if (nature === 'sortie') {
            newStock -= quantity;
        } else if (nature === 'inventaire') {
            newStock = quantity;
        }

        const color = newStock < 0 ? 'danger' : newStock <= {{ produit.seuil_alerte or 0 }} ? 'warning' : 'info';
        preview.className = `alert alert-${color}`;
        preview.innerHTML = `<small>Stock actuel: ${currentStock} → Nouveau stock: ${newStock}</small>`;
    }

    function submitMovement() {
        const form = document.getElementById('movementForm');
        const submitBtn = document.querySelector('#movementModal .btn-primary');
        const submitText = document.getElementById('submit-btn-text');
        const submitSpinner = document.getElementById('submit-btn-spinner');

        // Validation
        const quantity = parseInt(document.getElementById('movement-quantity').value);
        const user = document.getElementById('movement-user').value.trim();

        if (!quantity || quantity < 1) {
            alert('Veuillez entrer une quantité valide');
            return;
        }

        if (!user) {
            alert('Veuillez entrer votre nom');
            return;
        }

        // Disable button and show spinner
        submitBtn.disabled = true;
        submitText.classList.add('d-none');
        submitSpinner.classList.remove('d-none');

        const data = {
            reference: document.getElementById('movement-reference').value,
            nature: document.getElementById('movement-nature').value,
            quantite: quantity,
            utilisateur: user,
            commentaires: document.getElementById('movement-comments').value
        };

        fetch('/mouvement-stock', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(response => {
                if (response.success) {
                    alert('Mouvement enregistré avec succès');

                    // Mettre à jour le stock affiché
                    const newStock = response.nouveau_stock || (currentStock +
                        (data.nature === 'entree' ? quantity :
                         data.nature === 'sortie' ? -quantity :
                         quantity - currentStock));

                    currentStock = newStock;
                    updateStockDisplay(newStock);

                    // Recharger l'historique
                    loadHistorique();

                    // Fermer le modal
                    bootstrap.Modal.getInstance(document.getElementById('movementModal')).hide();
                } else {
                    alert(response.message || 'Erreur lors de l\'enregistrement');
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur lors de l\'enregistrement');
            })
            .finally(() => {
                // Re-enable button
                submitBtn.disabled = false;
                submitText.classList.remove('d-none');
                submitSpinner.classList.add('d-none');
            });
    }

    function updateStockDisplay(newStock) {
        // Mettre à jour l'affichage du stock dans la page
        const stockBadges = document.querySelectorAll('.badge');
        stockBadges.forEach(badge => {
            if (badge.textContent.trim() === currentStock.toString()) {
                badge.textContent = newStock;

                // Mettre à jour la classe selon le nouveau stock
                badge.className = 'badge fs-6 ' +
                    (newStock <= {{ produit.seuil_alerte or 0 }} ? 'bg-danger' :
                     newStock <= {{ produit.seuil_alerte or 0 }} * 2 ? 'bg-warning text-dark' : 'bg-success');
            }
        });
    }

    function downloadQR() {
        const qrImage = document.querySelector('#qr-code img');
        const link = document.createElement('a');
        link.download = `qr-${produit.reference}.png`;
        link.href = qrImage.src;
        link.click();
    }

    function shareQR() {
        if (navigator.share) {
            navigator.share({
                title: 'QR Code - {{ produit.nom or produit.reference }}',
                text: 'QR Code pour {{ produit.nom or produit.reference }} ({{ produit.reference }})',
                url: window.location.href
            });
        } else {
            // Fallback: copier l'URL
            navigator.clipboard.writeText(window.location.href).then(() => {
                alert('Lien copié dans le presse-papiers');
            });
        }
    }

    // Mise à jour du preview en temps réel
    document.getElementById('movement-quantity').addEventListener('input', updateStockPreview);
</script>
{% endblock %}
